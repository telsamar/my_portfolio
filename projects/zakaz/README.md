# Прогнозирование заявок на инсталляции

Проект выполнен в рамках заказа на разработку модели прогнозирования заявок на инсталляции по адресам. Система по историческим данным (даты назначений по адресам) строит прогноз количества заявок на день, неделю и месяц с учётом территорий, исключений и понижающих коэффициентов.

---

## Что делалось в заказе

### 1. Загрузка и предобработка данных

- **Входные данные** — Excel-файл с колонками:
  - адрес до квартиры;
  - последняя назначенная дата;
  - сервисный центр (СЦ);
  - территория/населенный пункт;
  - при наличии — широта и долгота.
- **Нормализация адресов**: приведение к единому виду, удаление номеров квартир (кв., квартира, к.) для группировки по «адрес до дома».
- **Парсинг дат** в единый формат, извлечение года, месяца и недели.
- **Определение города/территории**: из колонки «Территория» (г. XXX) или из адреса (название населённого пункта до ул./пер./д. и т.д.). При наличии уточняющего города из адреса он используется для отображения.

### 2. Конфигурация исключений и коэффициентов

Реализован гибкий конфиг (`input/forecast_config.json`), который влияет на то, как история учитывается в модели:

- **Исключения (exclusions)**  
  Указанные периоды (город + опционально месяц/год) полностью исключаются из расчёта. Примеры: аномалия по территории (потоп, сбой), отказ от учёта территории целиком.

- **Понижающие коэффициенты (coefficients)**  
  Для указанных город + месяц (и при необходимости год) заявки учитываются с весом 0.0–1.0. Например, сезонное снижение активности в декабре или в отдельном месяце по территории.

Правила применяются к строкам по полю «город» (регистронезависимо, допускается частичное совпадение). В результате у каждой строки появляется поле `weight`; нулевой вес — исключение из обучения, дробный — учёт с понижением.

### 3. Разбиение на области (кластеризация по координатам)

Если в данных есть широта и долгота:

- Адреса группируются по населённому пункту.
- Внутри города строится сетка ячеек с размером, задаваемым максимальным временем поездки (по умолчанию 15 минут при усреднённой скорости 30 км/ч).
- Адреса в одной ячейке объединяются в «область» при ограничении на максимальное количество домов на область (по умолчанию 15).
- В итоге у каждого адреса появляется метка области вида «Город-A», «Город-B» и т.д.

Области используются для группировки и сортировки в отчёте и для логического объединения близких адресов.

### 4. Модель прогнозирования

- **Обучение**: по каждому уникальному адресу (с учётом `weight`) считаются исторические метрики:
  - среднее число заявок в день;
  - среднее число заявок в неделю;
  - среднее число заявок в месяц;
  - доп. служебные показатели (разброс, последняя дата и т.д.).
- **Прогноз**:
  - **На день** — среднее по дням × поправка на день недели (понедельник выше, выходные ниже) × поправка на сезон (зима чуть ниже, лето чуть выше).
  - **На неделю** — среднее по неделям × поправка на день начала недели.
  - **На месяц** — среднее по месяцам × сезонная поправка.

Целевая дата дня — завтра; недели — следующий понедельник; месяца — первый день следующего месяца. Для адресов без истории прогноз даёт 0.

### 5. Выходной отчёт

Генерируется Excel-файл с колонками:

| Колонка | Описание |
|--------|----------|
| Область | Метка области (город + суффикс) или пусто, если нет координат |
| СЦ | Сервисный центр |
| Населенный пункт | Город для отображения (из территории или из адреса) |
| Адрес до дома | Нормализованный адрес |
| Прогноз заявок на день | Ожидаемое число заявок на целевой день |
| Прогноз заявок на неделю | На целевую неделю |
| Прогноз заявок на месяц | На целевой месяц |

Строки отсортированы по области, СЦ, населённому пункту и адресу.

### 6. Способы запуска

- **Консоль**: `python main.py` — один прогон с путями по умолчанию.
- **Интерактивное меню**: `python run_app.py` — показать конфиг, открыть конфиг в редакторе, запустить расчёт.
- **Графический интерфейс**: `python run_app_tk.py` — настройка исключений и коэффициентов в GUI и запуск расчёта.

При отсутствии `input/forecast_config.json` создаётся конфиг по умолчанию (пустые списки исключений и коэффициентов).

---

## Быстрый старт

1. Активировать виртуальное окружение:
   ```bash
   source venv/bin/activate
   ```

2. Установить зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Положить входной файл в `input/` с именем `my_file_result.xlsx` (или изменить константы в `main.py`).

4. Запуск:
   - **Один прогон**: `python main.py`
   - **Меню (конфиг + запуск)**: `python run_app.py`
   - **С графическим интерфейсом**: `python run_app_tk.py`

Результат появится в `output/forecast_result.xlsx` (или в указанном при вызове файле).

---

## Формат конфигурации

Файл: `input/forecast_config.json`.

```json
{
  "exclusions": [
    {
      "description": "Описание",
      "city": "Название города",
      "month": 11,
      "year": 2025,
      "action": "exclude"
    }
  ],
  "coefficients": [
    {
      "description": "Описание",
      "city": "Название города",
      "month": 11,
      "coefficient": 0.7
    }
  ]
}
```

- **exclusions**: записи с подходящими `city` (и при указании `month`/`year`) исключаются из расчёта (`weight = 0`).
- **coefficients**: для подходящих записей задаётся вес от 0.0 до 1.0 (например, 0.7 — снижение на 30%).  
- `city` — регистронезависимое частичное совпадение с полем города в данных.
- `month` (1–12) и `year` необязательны; если не указаны, правило применяется ко всем месяцам/годам по данной территории.

---

## Итог по заказу

В рамках заказа реализованы:

1. Конвейер от сырого Excel до прогноза по адресам с нормализацией адресов и дат.
2. Гибкая конфигурация исключений и понижающих коэффициентов по территориям и периодам.
3. Кластеризация адресов в области по координатам (время поездки, лимит домов на область).
4. Простая статистическая модель прогноза на день/неделю/месяц с учётом дня недели и сезона.
5. Вывод результата в Excel с группировкой по областям, СЦ и населённым пунктам.
6. Три варианта запуска: прямой вызов, консольное меню и GUI для настройки конфига и запуска расчёта.
